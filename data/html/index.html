<!DOCTYPE html>
<html lang='it'>
  <head>
    <meta charset="utf-8" />
    <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=http://outdatedbrowser.com/it"><![endif]-->
    <title>Configurazione SOMMM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <link rel="shortcut icon" type="image/png" href="./img/favico.png"/>
  </head>
  <body>
    <div id="navbar">
      <div id="logo"></div>
    </div>
    <div id="container">
      <form id="send">
        <div id="info" class="title_1">In funzione su: <span id="attuale"></span></div>
        <p class="title_1">Configurazione WiFi</p>
        <div id="rete_wireless">
          <!--SSID-->
          <label class="input_and_titles" for="net_ssid" style="position:absolute;margin-top:5px;">WIFI ssid </label>
          <br>
          <input class="input_and_titles long" type="text" name="FirstName" value="" id="net_ssid" required>
          <!--PSWD-->
          <br>
          <br>
          <label class="input_and_titles" for="net_pswd">Wifi Password </label>
          <br>
          <input class="input_and_titles long" type="password" name="FirstName" value="" id="net_pswd" placeholder="Lascia vuoto se non vuoi cambiarla">
        </div>
        <p class="title_1">Configurazione IP</p>
        <div class="box" style="left:5%;">
          <label for="net_static" class="title_1">Statico</label>
          <input type="checkbox" id="net_static" name="net_static" class="static" onclick="displayIPSettings(this.checked)">
        </div>
        <!--NET_IP-->
        <div id="indirizzo_ip" style="display:none;">
          <p class="title" style="padding-top:1.5rem;">Indirizzo IP</p>
          <div class="box">
            <input type="text" name="FirstName" value="" class="casella" id="net_ip" title="Inserisci un IP dispositivo valido" pattern="(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])">
          </div>
          <!--NET_SM-->
          <p class="title">Subnet Mask</p>
          <div class="box">
            <input type="text" name="FirstName" value="" class="casella" id="net_sm" title="Inserisci un IP subnet mask valido" pattern="(((255\.){3}(255|254|252|248|240|224|192|128|0+))|((255\.){2}(255|254|252|248|240|224|192|128|0+)\.0)|((255\.)(255|254|252|248|240|224|192|128|0+)(\.0+){2})|((255|254|252|248|240|224|192|128|0+)(\.0+){3}))">
          </div>
          <!--NET_DFGW-->
          <p class="title">Default Gateway</p>
          <div class="box">
            <input type="text" name="FirstName" value="" class="casella" id="net_dfgw" title="Inserisci un IP Default Gateway valido" pattern="(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])">
          </div>
          <!--NET_DNS-->
          <p class="title">Indirizzo DNS</p>
          <div class="box" style="padding-bottom:1.5rem;">
            <input type="text" name="FirstName" value="" class="casella" id="net_dns" title="Inserisci un indirizzo DNS valido" pattern="(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])">
          </div>
        </div>
        <p class="title_1">Impostazioni Generali</p>
        <div id="sensore">
          <!-- aula -->
          <label class="input_and_titles" for="aula" style="margin-top:5px;">Aula/Laboratorio</label>
          <br>
          <input class="input_and_titles long" type="text" value="" id="aula" pattern="[\w\d]+" required>
          <br>
          <br>
          <!-- api_url -->
          <label class="input_and_titles" for="api_url">API Url</label>
          <br>
          <input class="input_and_titles long" type="url" value="" id="api_url" required>
        </div>
        <div class="box" style="padding-top:1.5rem;">
          <input id="salva" class='button' type="submit" value="Salva">
        </div>
      </form>
    </div>
    <script>
      function qs(sel) { return document.querySelector(sel); }
      function displayIPSettings(isVisible) {
        qs("#indirizzo_ip").style.display = isVisible ? '': 'none';
        document.querySelectorAll("input.casella").forEach(
          function (userItem) { userItem.required = isVisible; }
        );
      }
      // and here's the trick (works everywhere)
      function g(f) { /in/.test(document.readyState) ? setTimeout('g(' + f + ')', 9) : f() }
      g(function() { // On document ready
          var r = new XMLHttpRequest();
          r.open('GET', '/config', true);
          r.onload = function() {
              if (r.status >= 200 && r.status < 400) { // Success!
                var configJson = JSON.parse(r.responseText);
                qs("#net_ssid").value = configJson["net_ssid"];
                qs("#aula").value = configJson["aula"];
                qs("#attuale").textContent = configJson["aula"];
                qs("#api_url").value = configJson["api_url"];
                if(configJson["net_static"] != null){
                  Object.entries(configJson["net_static"]).forEach(([key, value]) => {qs("#"+key).value=value.join(".")})
                  qs('#net_static').checked = true;
                  displayIPSettings(true);
                }
              } else console.error("Error on /config status " + r.status);
          };
          r.send();

          qs("#send").addEventListener("submit", function(e) {
              e.preventDefault(); //stop form from submitting
              var net_static;
              var net_ip = ['', '', '', ''];
              var net_sm = ['', '', '', ''];
              var net_dfgw = ['', '', '', ''];
              var net_dns = ['', '', '', ''];

              var net_ssid = qs("#net_ssid").value;
              var net_pswd = qs("#net_pswd").value;

              if (qs("#net_static").checked) {
                  net_ip = qs("#net_ip").value.split(".");
                  net_sm = qs("#net_sm").value.split(".");
                  net_dfgw = qs("#net_dfgw").value.split(".");
                  net_dns = qs("#net_dns").value.split(".");
                  net_static = {net_ip: net_ip, net_sm: net_sm, net_dfgw: net_dfgw, net_dns: net_dns}
              } else net_static = null;

              var aula = qs("#aula").value;
              var api_url = qs("#api_url").value;

              document.body.style.cursor = 'wait';
              qs("#salva").disabled = true;

              var params = {net_ssid: net_ssid, net_pswd: net_pswd, net_static: net_static, aula: aula, api_url: api_url};
              console.log(params);

              var r = new XMLHttpRequest();
              r.open('POST', '/save');
              r.setRequestHeader('Content-Type', 'application/json');
              r.onload = function() {
                  var resp = r.responseText;
                  if (r.status >= 200 && r.status < 400) console.log(resp); // Success!
                  // We reached our target server, but it returned an error (500)
                  else console.error("Error " + resp + " - status " + r.status);
                  alert(resp);
                  document.body.style.cursor = 'default';
                  qs("#salva").disabled = false;
              };
              r.onerror = function() {
                  // There was a connection error of some sort
                  document.body.style.cursor = 'default';
                  qs("#salva").disabled = false;
                  console.error('Errore di connessione: ' + r.responseText);
                  alert(r.responseText);
              };
              r.send(JSON.stringify(params));
          });
      });
    </script>
  </body>
</html>
